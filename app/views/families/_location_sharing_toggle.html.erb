<%= turbo_frame_tag "location-sharing-#{member.id}" do %>
  <div data-controller="location-sharing-toggle"
       data-location-sharing-toggle-member-id-value="<%= member.id %>"
       data-location-sharing-toggle-enabled-value="<%= member.family_sharing_enabled? %>"
       data-location-sharing-toggle-expires-at-value="<%= member.family_sharing_expires_at&.iso8601 %>"
       class="flex items-center gap-3">

    <span class="text-sm opacity-60">Location sharing:</span>

    <%= form_with url: location_sharing_family_path,
                  method: :patch,
                  data: {
                    turbo_frame: "location-sharing-#{member.id}",
                    location_sharing_toggle_target: "form"
                  } do |f| %>

      <%# Hidden field for enabled state - JS updates this before submit %>
      <%= f.hidden_field :enabled,
            value: member.family_sharing_enabled? ? "true" : "false",
            data: { location_sharing_toggle_target: "enabledField" } %>

      <%# Hidden field for duration %>
      <%= f.hidden_field :duration,
            value: member.family_sharing_duration || "permanent",
            data: { location_sharing_toggle_target: "durationField" } %>

      <%# Toggle Switch %>
      <input type="checkbox"
             class="toggle toggle-primary toggle-sm"
             <%= 'checked' if member.family_sharing_enabled? %>
             data-location-sharing-toggle-target="checkbox"
             data-action="change->location-sharing-toggle#toggle">

      <%# Duration Dropdown (only visible when enabled) %>
      <div class="<%= 'hidden' unless member.family_sharing_enabled? %>"
           data-location-sharing-toggle-target="durationContainer">
        <select class="select select-bordered select-xs w-28 h-full"
                data-location-sharing-toggle-target="durationSelect"
                data-action="change->location-sharing-toggle#changeDuration">
          <option value="permanent" <%= 'selected' if member.family_sharing_duration == 'permanent' %>>Always</option>
          <option value="1h" <%= 'selected' if member.family_sharing_duration == '1h' %>>1 hour</option>
          <option value="6h" <%= 'selected' if member.family_sharing_duration == '6h' %>>6 hours</option>
          <option value="12h" <%= 'selected' if member.family_sharing_duration == '12h' %>>12 hours</option>
          <option value="24h" <%= 'selected' if member.family_sharing_duration == '24h' %>>24 hours</option>
        </select>
      </div>

      <%# Expiration Info (inline) %>
      <% if member.family_sharing_enabled? && member.family_sharing_expires_at.present? %>
        <div class="text-xs opacity-50"
             data-location-sharing-toggle-target="expirationInfo">
          Expires <%= time_ago_in_words(member.family_sharing_expires_at) %> from now
        </div>
      <% else %>
        <div class="text-xs opacity-50 hidden"
             data-location-sharing-toggle-target="expirationInfo">
        </div>
      <% end %>
    <% end %>
  </div>
<% end %>
