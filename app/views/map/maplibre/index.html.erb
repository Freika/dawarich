<% content_for :title, 'Map' %>

<%= render 'shared/map/date_navigation_v2', start_at: @start_at, end_at: @end_at %>

<div id="maps-maplibre-container"
     data-controller="maps--maplibre area-drawer maps--maplibre-realtime"
     data-maps--maplibre-api-key-value="<%= current_user.api_key %>"
     data-maps--maplibre-start-date-value="<%= @start_at.iso8601 %>"
     data-maps--maplibre-end-date-value="<%= @end_at.iso8601 %>"
     data-maps--maplibre-timezone-value="<%= current_user.timezone %>"
     data-maps--maplibre-user-plan-value="<%= current_user.plan %>"
     data-maps--maplibre-realtime-enabled-value="true"
     data-maps--maplibre-realtime-live-mode-value="<%= current_user.safe_settings.live_map_enabled %>"
     style="width: 100%; height: 100%; position: relative;">

  <!-- WebGL error (hidden by default, shown if WebGL unavailable) -->
  <%= render 'map/maplibre/webgl_error' %>

  <!-- Map container takes full width and height -->
  <div data-maps--maplibre-target="container" class="maps-maplibre-container" style="width: 100%; height: 100%;"></div>

  <!-- Loading progress badge -->
  <div data-maps--maplibre-target="progressBadge" class="map-progress-badge">
    <span class="map-progress-badge-dot"></span>
    <span data-maps--maplibre-target="progressBadgeText">Loading...</span>
  </div>

  <!-- Settings button (top-left corner) -->
  <div class="absolute top-4 left-4 z-10">
    <button data-action="click->maps--maplibre#toggleSettings"
            class="btn btn-sm btn-primary"
            title="Open map settings">
      <%= icon 'square-pen' %>
      <span class="ml-1">Settings</span>
    </button>
  </div>

  <!-- Settings panel -->
  <%= render 'map/maplibre/settings_panel' %>

  <!-- Replay panel -->
  <%= render 'map/maplibre/replay_panel' %>

  <!-- Visit creation modal -->
  <%= render 'map/maplibre/visit_creation_modal' %>

  <!-- Area creation modal -->
  <%= render 'map/maplibre/area_creation_modal' %>

  <!-- Place creation modal (shared) -->
  <%= render 'shared/place_creation_modal' %>
</div>
